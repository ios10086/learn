# è‡ªåŠ¨åŒ–æ‰“åŒ…

### æ‰“åŒ…è„šæœ¬

```bash
#!/bin/sh

# ä½¿ç”¨æ–¹æ³•:
# step1: å°†è¯¥è„šæœ¬æ”¾åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ï¼ˆè·Ÿ.xcworkspaceæ–‡ä»¶or .xcodeprojæ–‡ä»¶åŒç›®å½•ï¼‰
# step2: æ ¹æ®æƒ…å†µä¿®æ”¹ä¸‹é¢çš„å‚æ•°
# step3: æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œè„šæœ¬ã€‚ï¼ˆè¾“å…¥sh ï¼Œç„¶åå°†è„šæœ¬æ–‡ä»¶æ‹‰åˆ°ç»ˆç«¯ï¼Œä¼šç”Ÿæˆæ–‡ä»¶è·¯å¾„ï¼Œç„¶åenterå°±å¯ï¼‰

# =============é¡¹ç›®è‡ªå®šä¹‰éƒ¨åˆ†(è‡ªå®šä¹‰å¥½ä¸‹åˆ—å‚æ•°åå†æ‰§è¡Œè¯¥è„šæœ¬)=================== #

# æ˜¯å¦ç¼–è¯‘å·¥ä½œç©ºé—´ (ä¾‹:è‹¥æ˜¯ç”¨Cocopodsç®¡ç†çš„.xcworkspaceé¡¹ç›®,èµ‹å€¼true;ç”¨Xcodeé»˜è®¤åˆ›å»ºçš„.xcodeproj,èµ‹å€¼false)
is_workspace="true"

# .xcworkspaceçš„åå­—ï¼Œå¦‚æœis_workspaceä¸ºtrueï¼Œåˆ™å¿…é¡»å¡«ã€‚å¦åˆ™å¯ä¸å¡«
workspace_name="hlEAM"

# .xcodeprojçš„åå­—ï¼Œå¦‚æœis_workspaceä¸ºfalseï¼Œåˆ™å¿…é¡»å¡«ã€‚å¦åˆ™å¯ä¸å¡«
project_name=""

# æŒ‡å®šé¡¹ç›®çš„schemeåç§°ï¼ˆä¹Ÿå°±æ˜¯å·¥ç¨‹çš„targetåç§°ï¼‰ï¼Œå¿…å¡«
scheme_name="hlEAM"

# æŒ‡å®šè¦æ‰“åŒ…ç¼–è¯‘çš„æ–¹å¼ : Release,Debugã€‚ä¸€èˆ¬ç”¨Releaseã€‚å¿…å¡«
build_configuration="Release"

# methodï¼Œæ‰“åŒ…çš„æ–¹å¼ã€‚æ–¹å¼åˆ†åˆ«ä¸º development, ad-hoc, app-store, enterprise ã€‚å¿…å¡«
method=""

#  ä¸‹é¢ä¸¤ä¸ªå‚æ•°åªæ˜¯åœ¨æ‰‹åŠ¨æŒ‡å®šPofileæ–‡ä»¶çš„æ—¶å€™ç”¨åˆ°ï¼Œå¦‚æœä½¿ç”¨Xcodeè‡ªåŠ¨ç®¡ç†Profile,ç›´æ¥ç•™ç©ºå°±å¥½
# (è·Ÿmethodå¯¹åº”çš„)mobileprovisionæ–‡ä»¶åï¼Œéœ€è¦å…ˆåŒå‡»å®‰è£….mobileprovisionæ–‡ä»¶.æ‰‹åŠ¨ç®¡ç†Profileæ—¶å¿…å¡«
mobileprovision_name=""

# é¡¹ç›®çš„bundleIDï¼Œæ‰‹åŠ¨ç®¡ç†Profileæ—¶å¿…å¡«
bundle_identifier=""

# APPåç§°
display_name=""

# APPç‰ˆæœ¬
app_version=""

# å¹³å°ä¸Šä¼ åŒ…åœ°å€
plant_url=""

# é¡¹ç›®æ„å»ºç¼–å·
build_number=""

#æ¡†æ¶ç‰ˆæœ¬
shell_branch=""

#éšæ‚£ç‰ˆæœ¬
yh_branch=""

#å®‰å…¨ç‰ˆæœ¬
ses_other_branch=""

#è®¾å¤‡ç‰ˆæœ¬
eam_branch=""

#ä½œä¸šç‰ˆæœ¬
wts_branch=""

while getopts 'a:b:c:d:e:f:g:h:i:j:k:m:' OPT; do
    echo "$OPTARG"
    case $OPT in
        a)
            method="$OPTARG";;
        b)
            bundle_identifier="$OPTARG";;
        c)
            display_name="$OPTARG";;
        d)
            app_version="$OPTARG";;
        e)
            ipa_name="$OPTARG";;
        f)
            plant_url="$OPTARG";;
        g)
            build_number="$OPTARG";;
        h)
            shell_branch="$OPTARG";;
        i)
            yh_branch="$OPTARG";;
        j)
            ses_other_branch="$OPTARG";;
        k)
            eam_branch="$OPTARG";;
        m)
            wts_branch="$OPTARG";;
        ?)
            echo "Usage: `basename $0` [options] filename"
    esac
done

echo "å•Šå•Šå•Šå•Šå•Š"


echo "--------------------è„šæœ¬é…ç½®å‚æ•°æ£€æŸ¥--------------------"
echo "is_workspace=${is_workspace} "
echo "workspace_name=${workspace_name}"
echo "project_name=${project_name}"
echo "scheme_name=${scheme_name}"
echo "build_configuration=${build_configuration}"
echo "bundle_identifier=${bundle_identifier}"
echo "method=${method}"
echo "mobileprovision_name=${mobileprovision_name}"


# =======================è„šæœ¬çš„ä¸€äº›å›ºå®šå‚æ•°å®šä¹‰(æ— ç‰¹æ®Šæƒ…å†µä¸ç”¨ä¿®æ”¹)====================== #

## è·å–å½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•
#script_dir="$( cd "$( dirname "$0"  )" && pwd  )"

#xworkspaceè·¯å¾„
script_dir="${WORKSPACE}/ISupPlant"

# å·¥ç¨‹æ ¹ç›®å½•
project_dir=$script_dir

# æ—¶é—´
DATE=`date '+%Y%m%d_%H%M%S'`
# æŒ‡å®šè¾“å‡ºå¯¼å‡ºæ–‡ä»¶å¤¹è·¯å¾„
#export_path="$project_dir/Package/$scheme_name-$DATE"
export_path="${WORKSPACE}/Package/$scheme_name-$DATE"
# æŒ‡å®šè¾“å‡ºå½’æ¡£æ–‡ä»¶è·¯å¾„
export_archive_path="$export_path/$scheme_name.xcarchive"
# æŒ‡å®šè¾“å‡ºipaæ–‡ä»¶å¤¹è·¯å¾„
export_ipa_path="$export_path"
# æŒ‡å®šè¾“å‡ºipaåç§°
if [ ipa_name = "" ]; then
ipa_name="${scheme_name}_${DATE}"
fi
# æŒ‡å®šå¯¼å‡ºipaåŒ…éœ€è¦ç”¨åˆ°çš„plisté…ç½®æ–‡ä»¶çš„è·¯å¾„
export_options_plist_path="$project_dir/ExportOptions.plist"


echo "--------------------è„šæœ¬å›ºå®šå‚æ•°æ£€æŸ¥--------------------"
echo "project_dir=${project_dir}"
echo "DATE=${DATE}"
echo "export_path=${export_path}"
echo "export_archive_path=${export_archive_path}"
echo "export_ipa_path=${export_ipa_path}"
echo "export_options_plist_path=${export_options_plist_path}"
echo "ipa_name=${ipa_name}"

# =======================å¢åŠ ä¸šåŠ¡æ¨¡å—ç‰ˆæœ¬ä¿¡æ¯====================== #
/usr/libexec/PlistBuddy -c "Set :modelBranch:SHELL_BRANCH ${shell_branch}" ${project_dir}/hlEAM/Info.plist
/usr/libexec/PlistBuddy -c "Set :modelBranch::YH_BRANCH ${yh_branch}" ${project_dir}/hlEAM/Info.plist
/usr/libexec/PlistBuddy -c "Set :modelBranch::SES_OTHER_BRANCH ${ses_other_branch}" ${project_dir}/hlEAM/Info.plist
/usr/libexec/PlistBuddy -c "Set :modelBranch::EAM_BRANCH ${eam_branch}" ${project_dir}/hlEAM/Info.plist
/usr/libexec/PlistBuddy -c "Set :modelBranch::WTS_BRANCH ${wts_branch}" ${project_dir}/hlEAM/Info.plist

# =======================ä¿®æ”¹APPé…ç½®ä¿¡æ¯====================== #
cd ${project_dir}/hlEAM.xcodeproj
sed -i "" "s/com.supcon.mobile.iSupPlant/${bundle_identifier}/g" project.pbxproj
/usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ${display_name}" ${project_dir}/hlEAM/Info.plist
/usr/libexec/PlistBuddy -c "Set :ipa_name ${ipa_name}" ${project_dir}/hlEAM/about.plist

cd ${project_dir}
xcrun agvtool new-marketing-version ${app_version}

# =======================è‡ªåŠ¨æ‰“åŒ…éƒ¨åˆ†(æ— ç‰¹æ®Šæƒ…å†µä¸ç”¨ä¿®æ”¹)====================== #
echo "------------------------------------------------------"
echo "å¼€å§‹æ„å»ºé¡¹ç›®"
# è¿›å…¥é¡¹ç›®å·¥ç¨‹ç›®å½•
cd ${project_dir}


# æŒ‡å®šè¾“å‡ºæ–‡ä»¶ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
if [ -d "$export_path" ] ; then
echo $export_path
else
mkdir -pv $export_path
fi

# åˆ¤æ–­ç¼–è¯‘çš„é¡¹ç›®ç±»å‹æ˜¯workspaceè¿˜æ˜¯project
if $is_workspace ; then
# ç¼–è¯‘å‰æ¸…ç†å·¥ç¨‹
xcodebuild clean -workspace ${workspace_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${build_configuration}

xcodebuild archive -workspace ${workspace_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${build_configuration} \
-archivePath ${export_archive_path}
else
# ç¼–è¯‘å‰æ¸…ç†å·¥ç¨‹
xcodebuild clean -project ${project_name}.xcodeproj \
-scheme ${scheme_name} \
-configuration ${build_configuration}

xcodebuild archive -project ${project_name}.xcodeproj \
-scheme ${scheme_name} \
-configuration ${build_configuration} \
-archivePath ${export_archive_path}
fi

#  æ£€æŸ¥æ˜¯å¦æ„å»ºæˆåŠŸ
#  xcarchive å®é™…æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶æ‰€ä»¥ä½¿ç”¨ -d åˆ¤æ–­
if [ -d "$export_archive_path" ] ; then
echo "é¡¹ç›®æ„å»ºæˆåŠŸ ğŸš€ ğŸš€ ğŸš€"
else
echo "é¡¹ç›®æ„å»ºå¤±è´¥ ğŸ˜¢ ğŸ˜¢ ğŸ˜¢"
exit 1
fi
echo "------------------------------------------------------"

echo "å¼€å§‹å¯¼å‡ºipaæ–‡ä»¶"


# å…ˆåˆ é™¤export_options_plistæ–‡ä»¶
if [ -f "$export_options_plist_path" ] ; then
#echo "${export_options_plist_path}æ–‡ä»¶å­˜åœ¨ï¼Œè¿›è¡Œåˆ é™¤"
rm -f $export_options_plist_path
fi
# æ ¹æ®å‚æ•°ç”Ÿæˆexport_options_plistæ–‡ä»¶
/usr/libexec/PlistBuddy -c  "Add :method String ${method}"  $export_options_plist_path
/usr/libexec/PlistBuddy -c  "Add :provisioningProfiles:"  $export_options_plist_path
/usr/libexec/PlistBuddy -c  "Add :provisioningProfiles:${bundle_identifier} String ${mobileprovision_name}"  $export_options_plist_path


xcodebuild  -exportArchive \
-archivePath ${export_archive_path} \
-exportPath ${export_ipa_path} \
-exportOptionsPlist ${export_options_plist_path} \
-allowProvisioningUpdates

# æ£€æŸ¥ipaæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ -f "$export_ipa_path/$scheme_name.ipa" ] ; then
echo "exportArchive ipaåŒ…æˆåŠŸ,å‡†å¤‡è¿›è¡Œé‡å‘½å"
else
echo "exportArchive ipaåŒ…å¤±è´¥ ğŸ˜¢ ğŸ˜¢ ğŸ˜¢"
exit 1
fi

# ä¿®æ”¹ipaæ–‡ä»¶åç§°
mv "${export_ipa_path}/${scheme_name}.ipa" "${export_ipa_path}/${ipa_name}.ipa"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ -f "$export_ipa_path/$ipa_name.ipa" ] ; then
echo "å¯¼å‡º ${ipa_name}.ipa åŒ…æˆåŠŸ ğŸ‰  ğŸ‰  ğŸ‰"
open $export_path
else
echo "å¯¼å‡º ${ipa_name}.ipa åŒ…å¤±è´¥ ğŸ˜¢ ğŸ˜¢ ğŸ˜¢"
exit 1
fi

# åˆ é™¤export_options_plistæ–‡ä»¶ï¼ˆä¸­é—´æ–‡ä»¶ï¼‰
if [ -f "$export_options_plist_path" ] ; then
#echo "${export_options_plist_path}æ–‡ä»¶å­˜åœ¨ï¼Œå‡†å¤‡åˆ é™¤"
rm -f $export_options_plist_path
fi

# è¾“å‡ºæ‰“åŒ…æ€»ç”¨æ—¶
echo "ä½¿ç”¨AutoPackageScriptæ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s"

filePath="$export_ipa_path/$ipa_name.ipa"
echo "3333:$filePath"

## ä¸Šä¼ åˆ°è’²å…¬è‹±
#json=$(curl -F "file=@$filePath" \
#-F "uKey=61860b1a4b5c365ee9c9bf880ef9dbf5" \
#-F "_api_key=08820f98036185e42ca4dfb53d426683" \
#https://www.pgyer.com/apiv1/app/upload)
#
## è’²å…¬è‹±ä¸‹è½½åœ°å€
#url=$(echo $json | jq -r '.data|.appQRCodeURL')
#
## ç”Ÿæˆjsonæ–‡ä»¶
#cd "${WORKSPACE}"
#echo "{
#\"url\":\"$url\"
#}" > url.json

# ä¸Šä¼ åˆ°å¹³å°
json=$(curl -F "file=@$filePath" \
-F "buildNumber=${build_number}" \
$plant_url/inter-api/mobile-platform/v1/appVersion/callback)

echo "4444:$json"

# å¹³å°ä¸‹è½½åœ°å€
url=$(echo $json | jq -r '.data|.downloadUrl')
updateDescription=$(echo $json | jq -r '.data|.updateDescription')

# ç”Ÿæˆjsonæ–‡ä»¶
cd "${WORKSPACE}"
echo "{
\"url\":\"$url\",
\"updateDescription\":\"$updateDescription\"
}" > url.json

exit 0


```

### jenkinså®‰è£…

ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„homebrewæ¥å®‰è£…Jenkins,åœ¨ç»ˆç«¯ä¸­è¿è¡Œ:

```bash
$ brew install Jenkins  
```

å¯åŠ¨Jenkins

```bash
$ jenkins
```

æµè§ˆå™¨è¾“å…¥http://localhost:8080æ‰“å¼€jenkinsã€‚

### jenkinsæ’ä»¶å®‰è£…

![](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ’ä»¶1.png)

##### Keychains and Provisioning Profiles Management

ç®¡ç†æœ¬åœ°çš„keychainå’ŒiOSè¯ä¹¦çš„æ’ä»¶

##### Xcode integration

ç”¨äºxcodeæ„å»º

##### fir-plugin

å°†ç§»åŠ¨åº”ç”¨ç¨‹åºï¼ˆAndroidï¼ŒiOSç­‰ï¼‰å‘å¸ƒåˆ°[æµ‹è¯•](http://fir.im/)å¹³å°ã€‚

![](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ’ä»¶2.png)

### é…ç½®Keychains and Provisioning Profiles Management

![é…ç½®](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/é…ç½®1.png)

å‰å¾€æ–‡ä»¶è·¯å¾„~/Library/Keychainsï¼Œå°†login.keychain-dbå¤åˆ¶å‡ºæ¥åˆ é™¤-dbï¼Œä¸Šä¼ login.keychainã€‚

ä¸‹å›¾çº¢æ¡†å›ºå®šä¸º/Users/ç”¨æˆ·å/Library/MobileDevice/Provisioning Profilesï¼Œåœ¨æ­¤è·¯å¾„ä¸‹é€‰æ‹©Provisioning Profilesæ–‡ä»¶ï¼Œç„¶åuploadã€‚

![é…ç½®é¡µé¢](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/é…ç½®2.png)

### æ„å»ºä»»åŠ¡

##### åˆ›å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„ä»»åŠ¡

![æ„å»ºä»»åŠ¡](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡1.png)

##### General

é€‰æ‹©ä¸¢å¼ƒæ—§çš„æ„å»ºï¼Œè‡³äºå¤©æ•°å’Œä¿æŒçš„æœ€å¤§ä¸ªæ•°ï¼ŒæŒ‰ç…§è‡ªå·±çš„éœ€æ±‚æ¥ã€‚

![æ„å»ºä»»åŠ¡2](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡2.png)

##### æºç ç®¡ç†

åœ¨Repository URLé‡Œé¢æ·»åŠ gitåœ°å€ï¼Œä½¿ç”¨sshå¡«ä¸Šå¯†é’¥ã€‚

![æ„å»ºä»»åŠ¡3](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡3.png)

##### æ„å»ºè§¦å‘å™¨

![æ„å»ºä»»åŠ¡4](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡4.png)

##### æ„å»ºç¯å¢ƒ

![æ„å»ºä»»åŠ¡5](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡5.png)

##### æ„å»º

å¯¼å…¥è„šæœ¬ã€‚

![æ„å»ºä»»åŠ¡6](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡6.png)

##### æ„å»ºåæ“ä½œ

å¡«å†™fir tokenã€build Notesï¼Œæ„å»ºå®Œæˆè‡ªåŠ¨ä¸Šä¼ è‡³firã€‚

![æ„å»ºä»»åŠ¡7](/Users/mac/Desktop/è‡ªåŠ¨åŒ–æ‰“åŒ…/æ„å»ºä»»åŠ¡7.png)

